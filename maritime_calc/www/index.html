<!DOCTYPE html>
<html lang="fr">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; media-src *; img-src 'self' data: content:;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur Maritime Complet</title>
    <style>
        :root {
            /* Palette Principale (Light) */
            --primary: #006064;
            --secondary: #00363a;
            --accent: #e0f7fa;
            --text: #333;
            --light-text: #fff;

            /* Backgrounds & Surfaces */
            --bg-body: #f0f4f8;
            --bg-container: #ffffff;
            --bg-input: #ffffff;
            --border-input: #cccccc;
            --shadow: rgba(0,0,0,0.1);

            /* Specific Elements */
            --bg-est-box: #fff3e0;
            --border-est-box: #ffe0b2;
            --text-est-title: #e65100;

            --orange-btn: #e65100;
            --orange-btn-hover: #bf360c;

            /* Status Colors (Light) */
            --text-success: #3c763d;
            --bg-success: #dff0d8;
            --border-success: #3c763d;

            --text-highlight: #006064;
            --text-warning-custom: #d84315;
            --text-muted: #757575;
        }

        [data-theme="dark"] {
            /* Palette Dark Mode */
            --primary: #64b5f6; /* Lighter Blue for better contrast on dark */
            --secondary: #1e88e5;
            --accent: #424242; /* Darker accent for results */
            --text: #e0e0e0;
            --light-text: #121212; /* Dark text on light blue headers */

            /* Backgrounds & Surfaces */
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --bg-input: #333333;
            --border-input: #555555;
            --shadow: rgba(0,0,0,0.5);

            /* Specific Elements */
            --bg-est-box: #3e2723;
            --border-est-box: #5d4037;
            --text-est-title: #ffb74d;

            --orange-btn: #ff9800;
            --orange-btn-hover: #fb8c00;

            /* Status Colors (Dark) */
            --text-success: #a5d6a7;
            --bg-success: #1b5e20;
            --border-success: #2e7d32;

            --text-highlight: #80deea;
            --text-warning-custom: #ffcc80;
            --text-muted: #bdbdbd;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background-color: var(--bg-body);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
        }

        header { background: linear-gradient(to right, var(--secondary), var(--primary)); color: var(--light-text); padding: 1rem; text-align: center; }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background: var(--bg-container);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow);
            transition: background-color 0.3s;
        }

        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }

        .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-size: 16px; font-weight: bold; color: #666; transition: 0.3s; }
        .tab-btn:hover { background-color: var(--accent); }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        [data-theme="dark"] .tab-btn { color: #aaa; }
        [data-theme="dark"] .tab-btn.active { color: var(--primary); }

        .tab-content { display: none; animation: fadeEffect 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border-input); border-radius: 4px; font-size: 16px; box-sizing: border-box; background-color: var(--bg-input); color: var(--text); }

        /* Style sp√©cial pour la section estimation */
        .estimation-box {
            background-color: var(--bg-est-box);
            border: 1px solid var(--border-est-box);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .estimation-box h3 { margin-top: 0; color: var(--text-est-title); font-size: 1em; }

        button.action-btn { background-color: var(--primary); color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 18px; margin-top: 10px; font-weight: bold; }
        button.action-btn:hover { background-color: var(--secondary); }
        button.calc-btn { background-color: var(--orange-btn); color: white; padding: 8px; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 5px; }
        button.calc-btn:hover { background-color: var(--orange-btn-hover); }

        .result-box { margin-top: 20px; padding: 20px; background-color: var(--accent); border-radius: 4px; border-left: 6px solid var(--primary); display: none; }
        .result-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1.1em; }
        .section-title { color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .warning { font-size: 0.8em; color: #999; text-align: center; margin-top: 30px; font-style: italic; }

        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }
        .theme-toggle:hover { background: rgba(255,255,255,0.3); }

        /* Dynamic Classes for JS/HTML refactoring */
        .box-light { background-color: #fafafa; border: 1px solid #ddd; }
        .box-info { background-color: #e0f7fa; border: 1px solid #b2ebf2; }
        .box-warning { background-color: #fff8e1; border: 1px solid #ffe0b2; }
        .box-shift { background-color: #e0f2f1; }
        .box-success { background-color: var(--bg-success); border: 1px solid var(--border-success); color: var(--text-success); }

        [data-theme="dark"] .box-light { background-color: #2c2c2c; border-color: #444; }
        [data-theme="dark"] .box-info { background-color: #004d40; border-color: #00695c; }
        [data-theme="dark"] .box-warning { background-color: #3e2723; border-color: #4e342e; }
        [data-theme="dark"] .box-shift { background-color: #00332c; }

        .text-highlight { color: var(--text-highlight); }
        .text-warning-custom { color: var(--text-warning-custom); }
        .text-muted { color: var(--text-muted); }
        .text-primary { color: var(--primary); }
        .text-orange { color: var(--orange-btn); }
        .text-est-title { color: var(--text-est-title); }
        .text-danger { color: #d32f2f; }
        [data-theme="dark"] .text-danger { color: #ef9a9a; }

        /* Input Placeholders */
        ::placeholder { color: #888; opacity: 1; }
        [data-theme="dark"] ::placeholder { color: #bbb; }
        [data-theme="dark"] input, [data-theme="dark"] select { color: #fff; }

        .delete-btn { background-color: #e57373; color: white; border: none; border-radius: 3px; padding: 5px; cursor: pointer; font-size: 0.8em; }
        [data-theme="dark"] .delete-btn { background-color: #c62828; }

        /* Bypass Checkbox Visibility Logic */
        .tank-bypass-start { display: none; }
        #shoreTanksContainer .shore-tank-row:first-child .tank-bypass-start { display: block; }

        /* Mobile Responsiveness */
        @media (max-width: 600px) {
            .container {
                margin: 10px auto;
                padding: 10px;
                width: 95%;
            }
            .tab-btn {
                padding: 10px 2px;
                font-size: 14px;
            }
            /* Stack input groups vertically */
            .est-inputs,
            .load-prod-inputs,
            .shore-tank-inputs {
                flex-direction: column !important;
            }
            /* Increase touch targets */
            .delete-btn {
                padding: 10px;
                font-size: 1em;
            }
            input, select, button {
                min-height: 44px; /* Better touch target */
            }
        }
    </style>
</head>
<body>

<header>
    <h1>Calculateur du p√®re Langlois</h1>
    <p>Il y a trois sortes de math√©maticiens : ceux qui savent compter et ceux qui ne savent pas. Benjamin Doreca</p>
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">üåô Mode Sombre</button>
</header>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'config')">Configuration</button>
        <button class="tab-btn" onclick="openTab(event, 'calc1m')">Calcul 1m (m¬≥)</button>
        <button class="tab-btn" onclick="openTab(event, 'converter')">Convertisseur</button>
        <button class="tab-btn" onclick="openTab(event, 'loading')">Chargement</button>
        <button class="tab-btn" onclick="openTab(event, 'unloading')">D√©chargement</button>
    </div>

    <div id="config" class="tab-content active">
        <h2 class="section-title">Param√®tres du Navire</h2>

        <div class="form-group">
            <label>DWT (Deadweight - Tonnes M√©triques) :</label>
            <input type="number" id="shipDwt" placeholder="Ex: 50000">
        </div>


        <div class="estimation-box">
            <h3>Calculateur de Hauteur (Optionnel)</h3>
            <p style="font-size:0.9em; margin-bottom:10px;">Si tu ne connais pas la hauteur des tanks, entre les dimensions du navire ci-dessous pour l'estimer √† partir du DWT.</p>
            <div class="est-inputs" style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>Longueur (LOA) m :</label>
                    <input type="number" id="shipLength" placeholder="Long.">
                </div>
                <div style="flex:1;">
                    <label>Largeur (Beam) m :</label>
                    <input type="number" id="shipBeam" placeholder="Larg.">
                </div>
            </div>
            <button class="calc-btn" onclick="estimateHeightFromDwt()">Estimer la Hauteur</button>
        </div>

        <div class="form-group">
            <label>Hauteur totale des tanks (M√®tres) :</label>
            <input type="number" id="tankHeight" placeholder="Calcul√© ou manuel...">
        </div>

        <div class="form-group">
            <label>Coefficient de Remplissage (%) :</label>
            <input type="number" id="fillCoeff" value="71" placeholder="Ex: 85">
            <small style="color:var(--text-muted); font-size:0.8em;">Ajustement pour la structure interne (Cadres, pompes, forme...)</small>
        </div>

        <div class="form-group">
            <label>Nombre de compartiments (Tanks) :</label>
            <input type="number" id="numTanks" placeholder="Ex: 10">
        </div>

        <button class="action-btn" onclick="saveConfig()">Sauvegarder Configuration</button>
        <div id="configMsg" class="result-box box-success" style="text-align: center;">
            Configuration sauvegard√©e !
        </div>
    </div>

    <div id="calc1m" class="tab-content">
        <h2 class="section-title">Volume requis pour 1m de niveau</h2>
        <button class="action-btn" onclick="calculateOneMeter()">Calculer le Volume pour 1m</button>

        <div id="result1m" class="result-box">
            <div class="result-item"><strong>Volume Total Navire :</strong> <span><span id="totalVol">0</span> m¬≥</span></div>
            <div class="result-item"><strong>Hauteur utilis√©e :</strong> <span><span id="usedHeight">0</span> m</span></div>
            <hr>
            <div class="result-item text-highlight" style="font-weight: bold; font-size: 1.2em;">
                Volume pour 1m (1 tank) : <span id="volOneTank1m">0</span> m¬≥
            </div>
            <div class="result-item">
                Volume pour 1m (Navire complet) : <span id="volAllTanks1m">0</span> m¬≥
            </div>
        </div>
    </div>

    <div id="converter" class="tab-content">
        <h2 class="section-title">Convertisseur de Volume (54A & 54B)</h2>

        <div class="form-group" id="directionSelect">
            <label for="conversionDirection">Sens de la conversion :</label>
            <select id="conversionDirection" onchange="updateLabels()">
                <option value="toOther">De 15 ¬∞C vers une autre temp√©rature</option>
                <option value="to15">D'une temp√©rature quelconque vers 15 ¬∞C</option>
            </select>
        </div>

        <div class="form-group">
            <label id="initialVolumeLabel" for="initialVolume">Volume √† 15¬∞C (L, m¬≥, etc.) :</label>
            <input type="number" id="initialVolume" placeholder="Entrez le volume initial" step="any" required>
        </div>

        <div class="form-group">
            <label id="temperatureLabel" for="temperature">Temp√©rature mesur√©e (¬∞C) :</label>
            <input type="number" id="temperature" placeholder="Entrez la temp√©rature actuelle" step="any" required>
        </div>

        <div class="form-group">
            <label for="productType">Type de produit :</label>
            <select id="productType">
                <option value="brut">P√©trole Brut (Table 54A)</option>
                <option value="raffiner">Produits Raffin√©s (Table 54B)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="density15">Densit√© relative √† 15¬∞C (ex: 0.8405) :</label>
            <input type="number" id="density15" placeholder="Ex: 0.8405" step="0.0001" required>
        </div>

        <button class="action-btn" onclick="calculateVolume()">Calculer</button>

        <div id="resultConverter" class="result-box"></div>
    </div>

    <div id="loading" class="tab-content">
        <h2 class="section-title">Chargement (m¬≥)</h2>
        <div class="form-group">
            <label>Date/Heure de d√©but (Optionnel - Par d√©faut : Maintenant) :</label>
            <input type="datetime-local" id="loadStartTime">
        </div>

        <div class="form-group box-info" style="padding: 10px; border-radius: 4px;">
            <label>S√©quence de Chargement (Produits) :</label>
            <div id="loadingProductsContainer"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="calc-btn" onclick="addLoadingProduct()" style="flex:1; background-color:#0097a7;">+ Ajouter Produit</button>
                <button class="calc-btn" onclick="resetLoadingProducts()" style="flex:1; background-color:#757575;">R√©initialiser</button>
            </div>
        </div>

        <button class="action-btn" onclick="calculateLoading()">Calculer Chargement</button>

        <div id="resultLoad" class="result-box">
            <div class="result-item"><strong>Reste √† charger :</strong> <span><span id="loadRemaining">0</span> m¬≥</span></div>
            <div class="result-item"><strong>Pourcentage :</strong> <span id="loadPercent">0</span> %</div>
            <hr>
            <div class="result-item" style="font-size: 1.3em; font-weight: bold;">
                Temps restant : <span id="loadTime">0h 00m</span>
            </div>
            <div id="loadExtraInfo" style="margin-top:15px; border-top: 1px dashed #bbb; padding-top:10px;"></div>
        </div>
    </div>

    <div id="unloading" class="tab-content">
        <h2 class="section-title">D√©chargement (m¬≥)</h2>
        <div class="form-group">
            <label>Date/Heure de d√©but (Optionnel - Par d√©faut : Maintenant) :</label>
            <input type="datetime-local" id="unloadStartTime">
        </div>
        <div class="form-group">
            <label>Volume Initial (m¬≥) :</label>
            <input type="number" id="unloadStart">
        </div>
        <div class="form-group">
            <label>Volume D√©charg√© (m¬≥) :</label>
            <input type="number" id="unloadDischarged">
        </div>
        <div class="form-group">
            <label>Taux de Pompage (m¬≥/h) :</label>
            <input type="number" id="unloadRate">
        </div>

        <div class="form-group box-warning" style="padding: 10px; border-radius: 4px;">
            <label>S√©quence R√©servoirs √† Terre (Optionnel) :</label>
            <div id="shoreTanksContainer"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="calc-btn" onclick="addShoreTank()" style="flex:1; background-color:#f57f17;">+ Ajouter R√©servoir</button>
                <button class="calc-btn" onclick="resetShoreTanks()" style="flex:1; background-color:#757575;">R√©initialiser</button>
            </div>
        </div>

        <button class="action-btn" onclick="calculateUnloading()">Calculer D√©chargement</button>

        <div id="resultUnload" class="result-box">
            <div class="result-item"><strong>Volume D√©charg√© :</strong> <span><span id="unloadDone">0</span> m¬≥</span></div>
            <div class="result-item"><strong>Reste √† pomper :</strong> <span><span id="unloadRemaining">0</span> m¬≥</span></div>
            <hr>
            <div class="result-item" style="font-size: 1.3em; font-weight: bold;">
                Temps restant : <span id="unloadTime">0h 00m</span>
            </div>
            <div id="unloadExtraInfo" style="margin-top:15px; border-top: 1px dashed #bbb; padding-top:10px;"></div>
        </div>
    </div>
</div>

<script>
    // --- Theme Logic ---
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
        localStorage.setItem('theme', newTheme);
    }

    function applyTheme(theme) {
        const html = document.documentElement;
        const btn = document.getElementById('themeBtn');
        if (theme === 'dark') {
            html.setAttribute('data-theme', 'dark');
            btn.innerText = '‚òÄÔ∏è Mode Clair';
        } else {
            html.removeAttribute('data-theme');
            btn.innerText = 'üåô Mode Sombre';
        }
    }

    // Variables
    let dwt = 0;
    let tanks = 0;
    let height = 0;
    let density = 1.025;
    let coeff = 0.71;

    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; tabcontent[i].classList.remove("active"); }
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.className += " active";
    }

    // --- NOUVELLE FONCTION : Estimation de la hauteur ---
    function estimateHeightFromDwt() {
        let d = parseFloat(document.getElementById('shipDwt').value) || 0;
        let den = 1.025;
        let l = parseFloat(document.getElementById('shipLength').value) || 0;
        let w = parseFloat(document.getElementById('shipBeam').value) || 0;

        if (d === 0 || l === 0 || w === 0) {
            alert("Pour estimer la hauteur, il faut : DWT, Longueur et Largeur.");
            return;
        }

        // 1. Calcul du Volume Total requis pour ce DWT
        let totalVolume = d / den;

        // 2. Calcul de la surface du pont (Aire)
        let area = l * w;

        // 3. Calcul de la Hauteur th√©orique
        // Formule : Hauteur = Volume / (Surface * Coefficient de Remplissage)
        // On utilise un coefficient de 0.85 (Block Coefficient moyen pour tankers)
        // car le navire n'est pas une bo√Æte carr√©e parfaite.
        let estimatedHeight = totalVolume / (area * 0.85);

        // Mise √† jour du champ
        document.getElementById('tankHeight').value = estimatedHeight.toFixed(2);

        alert("Hauteur estim√©e √† " + estimatedHeight.toFixed(2) + " m√®tres (bas√©e sur un coefficient de coque de 0.85).");
    }

    function saveConfig() {
        dwt = parseFloat(document.getElementById('shipDwt').value) || 0;
        tanks = parseFloat(document.getElementById('numTanks').value);
        if (isNaN(tanks) || tanks === 0) {
            tanks = 14; // Default to 14 if empty or 0
        }
        height = parseFloat(document.getElementById('tankHeight').value) || 0;
        let c = parseFloat(document.getElementById('fillCoeff').value);
        coeff = (isNaN(c) ? 71 : c) / 100;
        density = 1.025;

        document.getElementById('configMsg').style.display = 'block';
        setTimeout(() => { document.getElementById('configMsg').style.display = 'none'; }, 2000);
    }

    function calculateOneMeter() {
        saveConfig(); // S'assurer que les variables sont √† jour
        if (dwt === 0 || tanks === 0 || height === 0) {
            alert("Config incompl√®te (DWT, Tanks ou Hauteur manquants).");
            return;
        }

        // Volume Th√©orique (Bo√Æte parfaite de densit√© 1.025)
        let theoreticalVolume = dwt / density;

        // Volume R√©el Estim√© (Avec coefficient de forme/structure)
        let adjustedVolume = theoreticalVolume * coeff;

        let volumePerTank = adjustedVolume / tanks;
        let volumePerMeter = volumePerTank / height;

        document.getElementById('totalVol').innerText = adjustedVolume.toFixed(1);
        document.getElementById('usedHeight').innerText = height.toFixed(2);
        document.getElementById('volOneTank1m').innerText = volumePerMeter.toFixed(2);
        document.getElementById('volAllTanks1m').innerText = (volumePerMeter * tanks).toFixed(2);

        document.getElementById('result1m').style.display = 'block';
    }

    // --- Loading Multiple Products Logic ---
    let loadProdCount = 0;
    function addLoadingProduct() {
        loadProdCount++;
        const div = document.createElement('div');
        div.className = 'load-prod-row box-light';
        div.style.display = 'flex';
        div.style.flexDirection = 'column';
        div.style.gap = '5px';
        div.style.marginBottom = '15px';
        div.style.padding = '10px';
        div.style.borderRadius = '4px';

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <input type="text" placeholder="Nom du Produit (Ex: Prod A)" class="load-prod-name" style="width:70%;">
                <button onclick="this.parentElement.parentElement.remove()" class="delete-btn">X</button>
            </div>

            <div class="load-prod-inputs" style="display:flex; gap:5px; margin-bottom:5px;">
                <div style="flex:1;"><label style="font-size:0.8em;">Total (m¬≥)</label><input type="number" class="load-prod-target"></div>
                <div style="flex:1;"><label style="font-size:0.8em;">√Ä bord (m¬≥)</label><input type="number" class="load-prod-current"></div>
                <div style="flex:1;"><label style="font-size:0.8em;">Taux (m¬≥/h)</label><input type="number" class="load-prod-rate"></div>
            </div>

            <div style="display:flex; flex-direction:column; gap:5px; padding-top:5px; border-top:1px dashed #ccc;">
                 <label class="text-warning-custom" style="display:flex; align-items:center; font-size:0.9em; cursor:pointer; margin-bottom:5px;">
                    <input type="checkbox" class="load-prod-sampling" style="width:auto; margin-right:5px;">
                    Echantillonnage 1m (+45min)
                </label>
                 <label class="text-highlight" style="display:flex; align-items:center; font-size:0.9em; cursor:pointer;">
                    <input type="checkbox" class="load-prod-shift-toggle" style="width:auto; margin-right:5px;" onchange="this.parentElement.nextElementSibling.style.display = this.checked ? 'flex' : 'none'">
                    Arr√™t d√©placement pendant ce produit
                </label>
                <div class="load-prod-shift-details box-shift" style="display:none; gap:5px; padding:5px; border-radius:3px;">
                     <div style="flex:1;"><label style="font-size:0.8em;">Arr√™t si reste (m¬≥)</label><input type="number" class="load-prod-shift-rem" placeholder="Ex: 500"></div>
                     <div style="flex:1;"><label style="font-size:0.8em;">Dur√©e (min)</label><input type="number" class="load-prod-shift-dur" placeholder="Ex: 60"></div>
                </div>
            </div>

            <div style="margin-top:5px;">
                <label style="font-size:0.8em;">D√©lai APRES ce produit (min) :</label>
                <input type="number" class="load-prod-delay-after" placeholder="Ex: 30">
            </div>
        `;
        document.getElementById('loadingProductsContainer').appendChild(div);
    }

    function resetLoadingProducts() {
        document.getElementById('loadingProductsContainer').innerHTML = '';
        loadProdCount = 0;
        addLoadingProduct();
    }

    function calculateLoading() {
        let totalTarget = 0;
        let totalCurrent = 0;
        let totalRemaining = 0;
        let totalTimeHours = 0;

        let startTimeVal = document.getElementById('loadStartTime').value;
        let now = startTimeVal ? new Date(startTimeVal) : new Date();

        let cumulativeTimeMins = 0;
        let extraHtml = "";
        let productScheduleHtml = "";

        // Iterate Products
        const rows = document.querySelectorAll('.load-prod-row');
        let hasData = false;

        if (rows.length > 0) {
             productScheduleHtml += `<div style="margin-top:15px; padding-top:10px; border-top:1px solid #ddd;"><h4 class="text-primary" style="margin:0 0 10px 0;">S√©quence de Chargement :</h4>`;
        }

        rows.forEach(row => {
            let name = row.querySelector('.load-prod-name').value || "Produit";
            let t = parseFloat(row.querySelector('.load-prod-target').value) || 0;
            let c = parseFloat(row.querySelector('.load-prod-current').value) || 0;
            let r = parseFloat(row.querySelector('.load-prod-rate').value) || 0;
            let delayAfter = parseFloat(row.querySelector('.load-prod-delay-after').value) || 0;

            let rem = t - c;
            if (rem < 0) rem = 0;

            totalTarget += t;
            totalCurrent += c;
            totalRemaining += rem;

            if (t > 0 || r > 0) hasData = true;

            // Sampling Logic
            let samplingEnabled = row.querySelector('.load-prod-sampling').checked;
            if (samplingEnabled) {
                cumulativeTimeMins += 45;
            }

            // Shift Logic for this product
            let shiftEnabled = row.querySelector('.load-prod-shift-toggle').checked;
            let shiftDuration = 0;
            let shiftMsg = "";
            let pumpingDurationHours = (r > 0) ? (rem / r) : 0;
            let pumpingDurationMins = pumpingDurationHours * 60;

            if (shiftEnabled && rem > 0 && r > 0) {
                 let shiftTrigger = parseFloat(row.querySelector('.load-prod-shift-rem').value) || 0;
                 let shiftDurInput = parseFloat(row.querySelector('.load-prod-shift-dur').value) || 0;

                 // Logic: Stop when 'shiftTrigger' remains FOR THIS PRODUCT.
                 // So we pump (rem - shiftTrigger).
                 let volBeforeStop = rem - shiftTrigger;

                 if (volBeforeStop > 0) {
                     let timeToStopMins = (volBeforeStop / r) * 60;
                     shiftDuration = shiftDurInput;

                     // Add pre-stop pumping time
                     cumulativeTimeMins += timeToStopMins;
                     let stopDate = addMinutes(now, cumulativeTimeMins);

                     // Add Shift Duration
                     cumulativeTimeMins += shiftDuration;

                     // Add remaining pumping time
                     let remainingPumpingMins = pumpingDurationMins - timeToStopMins;
                     cumulativeTimeMins += remainingPumpingMins;

                     shiftMsg = `<div class="text-orange" style="font-size:0.9em; margin-left:10px;">‚ûú Arr√™t d√©pla. (${shiftDuration}m) √† ${formatDateTime(stopDate)}</div>`;
                 } else {
                     // Shift trigger not met (already past or equal), just pump
                     cumulativeTimeMins += pumpingDurationMins;
                 }
            } else {
                 cumulativeTimeMins += pumpingDurationMins;
            }

            // Add Delay After
            if (delayAfter > 0) {
                cumulativeTimeMins += delayAfter;
            }

            totalTimeHours = cumulativeTimeMins / 60;
            let pEndDate = addMinutes(now, cumulativeTimeMins);

            if (rem > 0 || delayAfter > 0 || samplingEnabled) {
                productScheduleHtml += `
                    <div style="margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:5px;">
                        <div style="display:flex; justify-content:space-between; font-size:1em;">
                            <strong>${name} (${rem.toFixed(0)} m¬≥)</strong>
                            <span>Fin : ${formatDateTime(pEndDate)}</span>
                        </div>
                        ${samplingEnabled ? `<div class="text-orange" style="font-size:0.9em; margin-left:10px;">‚ûú Echantillonnage 1m (+45 min)</div>` : ''}
                        ${shiftMsg}
                        ${delayAfter > 0 ? `<div class="text-muted" style="font-size:0.9em; margin-left:10px;">‚ûú D√©lai apr√®s : ${delayAfter} min</div>` : ''}
                    </div>
                `;
            }
        });

        productScheduleHtml += `</div>`;

        if (!hasData) return;

        let percent = (totalTarget > 0) ? (totalCurrent / totalTarget) * 100 : 0;

        let h = Math.floor(totalTimeHours);
        let m = Math.round((totalTimeHours - h) * 60);
        let endDate = addMinutes(now, totalTimeHours * 60);

        document.getElementById('loadRemaining').innerText = totalRemaining.toFixed(1);
        document.getElementById('loadPercent').innerText = percent.toFixed(1);
        document.getElementById('loadTime').innerText = h + "h " + m + "m";
        document.getElementById('resultLoad').style.display = 'block';

        extraHtml = `<div class="result-item text-primary" style="margin-top:10px; font-weight:bold;">Fin estim√©e : ${formatDateTime(endDate)}</div>`;
        extraHtml += productScheduleHtml;

        document.getElementById('loadExtraInfo').innerHTML = extraHtml;
    }

    // --- Unloading Logic with Multiple Tanks ---
    let tankCount = 0;
    function addShoreTank() {
        tankCount++;
        const div = document.createElement('div');
        div.className = 'shore-tank-row box-light';
        div.style.padding = '10px';
        div.style.marginBottom = '10px';
        div.style.borderRadius = '4px';

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <input type="text" placeholder="Nom (Ex: Tk 1)" class="tank-name" style="width:85%;">
                <button onclick="this.parentElement.parentElement.remove()" class="delete-btn">X</button>
            </div>
            <div class="shore-tank-inputs" style="display:flex; gap:5px; margin-bottom:5px;">
                <div style="flex:1;"><label style="font-size:0.8em;">Qt√© (m¬≥)</label><input type="number" class="tank-qty"></div>
                <div style="flex:1;"><label style="font-size:0.8em;">D√©lai Avant (min)</label><input type="number" class="tank-delay"></div>
            </div>

            <div style="border-top:1px dashed #ccc; padding-top:5px; margin-top:5px;">
                <div class="tank-bypass-start" style="margin-bottom: 5px;">
                     <label class="text-warning-custom" style="display:flex; align-items:center; font-size:0.9em; cursor:pointer;">
                        <input type="checkbox" class="tank-bypass-check" style="width:auto; margin-right:5px;">
                        Bypass 30m D√©marrage
                    </label>
                </div>

                <label class="text-orange" style="display:flex; align-items:center; font-size:0.9em; cursor:pointer;">
                    <input type="checkbox" class="tank-slow-toggle" style="width:auto; margin-right:5px;" onchange="this.parentElement.nextElementSibling.style.display = this.checked ? 'flex' : 'none'">
                    Ajouter Ralentissement
                </label>
                <div class="tank-slow-inputs box-warning" style="display:none; gap:5px; padding:5px; margin-top:5px; border-radius:3px;">
                     <div style="flex:1;"><label style="font-size:0.8em;">D√©bit Restreint (m¬≥/h)</label><input type="number" class="tank-slow-rate" placeholder="Ex: 500"></div>
                     <div style="flex:1;"><label style="font-size:0.8em;">Dur√©e (min)</label><input type="number" class="tank-slow-dur" placeholder="Ex: 30"></div>
                </div>
            </div>
        `;
        document.getElementById('shoreTanksContainer').appendChild(div);
    }

    function resetShoreTanks() {
        document.getElementById('shoreTanksContainer').innerHTML = '';
        tankCount = 0;
        addShoreTank();
    }

    function calculateUnloading() {
        let start = parseFloat(document.getElementById('unloadStart').value) || 0;
        let discharged = parseFloat(document.getElementById('unloadDischarged').value) || 0;
        let rate = parseFloat(document.getElementById('unloadRate').value) || 0;
        if (rate === 0) return;

        let current = start - discharged; // Remaining to pump globally
        if (current < 0) current = 0;

        let startTimeVal = document.getElementById('unloadStartTime').value;
        let now = startTimeVal ? new Date(startTimeVal) : new Date();

        let extraHtml = "";

        // Shore Tanks Schedule with Slow Start Logic
        const tankRows = document.querySelectorAll('.shore-tank-row');
        let hasTanks = false;
        tankRows.forEach(row => { if(row.querySelector('.tank-qty').value) hasTanks = true; });

        let totalDurationMins = 0;
        let remainingDischargedForCalc = discharged; // Volume "already done" to distribute
        let totalRemainingCapacityInTanks = 0; // To track unassigned

        if (hasTanks) {
            extraHtml += `<div style="margin-top:15px; padding-top:10px; border-top:1px solid #ddd;"><h4 class="text-est-title" style="margin:0 0 10px 0;">S√©quence R√©servoirs :</h4>`;

            // Pre-calculation: Auto-fill last tank if needed
            let sumOtherTanks = 0;
            let lastTankIndex = tankRows.length - 1;

            // Calculate sum of all valid quantities EXCEPT the last one if it's empty/0
            for(let i=0; i<tankRows.length; i++) {
                let q = parseFloat(tankRows[i].querySelector('.tank-qty').value) || 0;
                if (i !== lastTankIndex || q > 0) {
                    sumOtherTanks += q;
                }
            }

            tankRows.forEach((row, index) => {
                let name = row.querySelector('.tank-name').value || `R√©servoir ${index + 1}`;
                let qtyInput = parseFloat(row.querySelector('.tank-qty').value) || 0;
                let delay = parseFloat(row.querySelector('.tank-delay').value) || 0;

                let qty = qtyInput;
                let isAutoCalc = false;

                // Auto-calc logic for last tank
                if (index === lastTankIndex && qtyInput === 0) {
                    let remainder = current - sumOtherTanks; // current is remaining to pump globally
                    // Wait, 'current' is (Start - Discharged).
                    // We need to base the auto-fill on the TOTAL Start volume vs Other Tanks capacity.
                    // If user says "Start 5000", Tank1=2000. Then Tank2 should be 3000.
                    // Regardless of how much is discharged.
                    let totalStart = parseFloat(document.getElementById('unloadStart').value) || 0;
                    let autoVal = totalStart - sumOtherTanks;

                    if (autoVal > 0) {
                        qty = autoVal;
                        isAutoCalc = true;
                    }
                }

                // Slowdown inputs
                let slowRateInput = parseFloat(row.querySelector('.tank-slow-rate').value) || 0;
                let slowDurInput = parseFloat(row.querySelector('.tank-slow-dur').value) || 0;
                let useSlowdown = row.querySelector('.tank-slow-toggle').checked && slowRateInput > 0 && slowDurInput > 0;

                if (qty > 0) {
                    // Determine how much of this tank is already filled
                    let filledAlready = 0;
                    if (remainingDischargedForCalc >= qty) {
                        filledAlready = qty;
                        remainingDischargedForCalc -= qty;
                    } else {
                        filledAlready = remainingDischargedForCalc;
                        remainingDischargedForCalc = 0;
                    }

                    let remainingInTank = qty - filledAlready;
                    totalRemainingCapacityInTanks += remainingInTank;

                    let tankDurationMins = 0;
                    let msgs = [];
                    let tankStatus = "";
                    let tankClass = ""; // For styling

                    if (remainingInTank <= 0) {
                         tankStatus = `<span class="text-muted" style="font-weight:bold;">(Termin√©)</span>`;
                         tankClass = "opacity: 0.5;";
                    } else {
                        // Tank is active or future
                        let isPartial = (filledAlready > 0);

                        // 1. Delay
                        // Skip delay if partially filled (active)
                        if (!isPartial) {
                             totalDurationMins += delay;
                             if (delay > 0) msgs.push(`<div class="text-muted" style="font-size:0.85em; margin-left:10px;">‚ûú D√©lai avant : ${delay} min</div>`);
                        } else {
                             if (delay > 0) msgs.push(`<div class="text-muted" style="font-size:0.85em; text-decoration:line-through; margin-left:10px;">‚ûú D√©lai (D√©j√† pass√©)</div>`);
                        }

                        // We have 'remainingInTank' to pump.
                        // We need to see which phases are left.
                        // We simulate the phases with volumes.

                        let volDone = filledAlready; // The volume we have already traversed in the phases

                        // --- Phase 1: Slow Start ---
                        let bypassCheck = row.querySelector('.tank-bypass-check');
                        let isBypass = (index === 0 && bypassCheck && bypassCheck.checked);
                        let phase1Vol = 0;
                        let phase1Rate = 0;
                        let phase1Dur = 0;

                        if (!isBypass) {
                            phase1Dur = 30;
                            phase1Rate = (rate > 3000) ? 3000 : rate;
                            phase1Vol = phase1Rate * (phase1Dur / 60);
                        }

                        // Process Phase 1
                        if (phase1Vol > 0) {
                             if (volDone >= phase1Vol) {
                                 // Phase 1 fully done
                                 volDone -= phase1Vol;
                                 msgs.push(`<div class="text-muted" style="font-size:0.85em; margin-left:10px;">‚ûú D√©marrage (Termin√©)</div>`);
                             } else {
                                 // Phase 1 partially or not done
                                 let effectivePhase1Vol = Math.min(phase1Vol, qty); // Cap phase 1 by total tank size
                                 let workLeftInPhase1 = effectivePhase1Vol - volDone;

                                 // If workLeftInPhase1 > remainingInTank, clamp it.
                                 if (workLeftInPhase1 > remainingInTank) workLeftInPhase1 = remainingInTank;

                                 if (workLeftInPhase1 > 0) {
                                     let time = (workLeftInPhase1 / phase1Rate) * 60;
                                     tankDurationMins += time;
                                     remainingInTank -= workLeftInPhase1;
                                     msgs.push(`<div class="text-muted" style="font-size:0.85em; margin-left:10px;">‚ûú D√©marrage (Reste) : ${time.toFixed(1)}m @ ${phase1Rate.toFixed(0)}</div>`);
                                 }

                                 // We have consumed the 'volDone' for Phase 1 context.
                                 volDone = 0;
                             }
                        }

                        // --- Phase 2: Manual Slowdown ---
                        if (remainingInTank > 0 && useSlowdown) {
                            let phase2Vol = slowRateInput * (slowDurInput / 60);

                            if (volDone >= phase2Vol) {
                                // Phase 2 fully done
                                volDone -= phase2Vol;
                                msgs.push(`<div class="text-muted" style="font-size:0.85em; margin-left:10px;">‚ûú Ralenti (Termin√©)</div>`);
                            } else {
                                // We are in Phase 2 or at start of it
                                let workLeftInPhase2 = phase2Vol - volDone;
                                if (workLeftInPhase2 > remainingInTank) workLeftInPhase2 = remainingInTank;

                                if (workLeftInPhase2 > 0) {
                                    let time = (workLeftInPhase2 / slowRateInput) * 60;
                                    tankDurationMins += time;
                                    remainingInTank -= workLeftInPhase2;
                                     msgs.push(`<div class="text-orange" style="font-size:0.85em; margin-left:10px;">‚ûú Ralenti (Reste) : ${time.toFixed(1)}m @ ${slowRateInput}</div>`);
                                }
                                volDone = 0;
                            }
                        }

                        // --- Phase 3: Normal ---
                        if (remainingInTank > 0) {
                             let time = (remainingInTank / rate) * 60;
                             tankDurationMins += time;
                             remainingInTank = 0;
                        }

                        totalDurationMins += tankDurationMins;
                    }

                    let tankEndTime = addMinutes(now, totalDurationMins);

                    extraHtml += `
                        <div style="margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:5px; ${tankClass}">
                            <div style="display:flex; justify-content:space-between; font-size:1em;">
                                <span>${name} (${qty} m¬≥${isAutoCalc ? '*' : ''}) ${tankStatus}</span>
                                ${tankStatus !== "" ?
                                    `<span>-</span>` :
                                    `<span style="font-weight:bold;">Fin : ${formatDateTime(tankEndTime)}</span>`
                                }
                            </div>
                            ${msgs.join('')}
                            ${isAutoCalc ? `<div class="text-primary" style="font-size:0.8em; font-style:italic;">* Calcul√© automatiquement (Reste)</div>` : ''}
                        </div>
                    `;
                }
            });

            // Unassigned
            // current is (Start - Discharged).
            // totalRemainingCapacityInTanks is sum(Tank - Filled).
            // unassigned = current - totalRemainingCapacityInTanks.
            let unassigned = current - totalRemainingCapacityInTanks;

             if (unassigned > 0.01) {
                 let unassignedHours = unassigned / rate;
                 let unassignedMins = unassignedHours * 60;
                 totalDurationMins += unassignedMins;
                 let finalEndTime = addMinutes(now, totalDurationMins);

                 extraHtml += `
                    <div class="text-muted" style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.95em; font-style:italic;">
                        <span>Reste non assign√© (${unassigned.toFixed(1)} m¬≥)</span>
                        <span>Fin : ${formatDateTime(finalEndTime)}</span>
                    </div>
                `;
            } else if (unassigned < -0.01) {
                 extraHtml += `<div class="text-danger" style="font-size:0.9em;">Attention: La somme restante des r√©servoirs (${totalRemainingCapacityInTanks} m¬≥) d√©passe le reste √† pomper (${current} m¬≥) !</div>`;
            }

            let finalDate = addMinutes(now, totalDurationMins);
            extraHtml = `<div class="result-item text-primary" style="margin-top:10px; font-weight:bold;">Fin estim√©e (Ajust√©e) : ${formatDateTime(finalDate)}</div>` + extraHtml;
            extraHtml += `</div>`;
        } else {
             // Fallback for simple calculation without tanks list
             let timeHours = current / rate;
             totalDurationMins = timeHours * 60;
             let endDate = addMinutes(now, totalDurationMins);
             extraHtml = `<div class="result-item text-primary" style="margin-top:10px; font-weight:bold;">Fin estim√©e (Simple) : ${formatDateTime(endDate)}</div>`;
        }

        let h = Math.floor(totalDurationMins / 60);
        let m = Math.round(totalDurationMins % 60);

        document.getElementById('unloadDone').innerText = discharged.toFixed(1);
        document.getElementById('unloadRemaining').innerText = current.toFixed(1);
        document.getElementById('unloadTime').innerText = h + "h " + m + "m";
        document.getElementById('resultUnload').style.display = 'block';

        document.getElementById('unloadExtraInfo').innerHTML = extraHtml;
    }

    // --- Utilitaires de Date ---
    function formatDateTime(date) {
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    function addMinutes(date, minutes) {
        return new Date(date.getTime() + minutes * 60000);
    }

    // --- Converter Logic ---
    const INITIAL_TEMP = 15;

    function updateLabels() {
        const direction = document.getElementById('conversionDirection').value;
        const initialVolumeLabel = document.getElementById('initialVolumeLabel');
        const temperatureLabel = document.getElementById('temperatureLabel');

        if (direction === 'toOther') {
            initialVolumeLabel.textContent = 'Volume √† 15¬∞C (L, m¬≥, etc.) :';
            temperatureLabel.textContent = 'Temp√©rature cible (¬∞C) :';
        } else {
            initialVolumeLabel.textContent = 'Volume mesur√© (L, m¬≥, etc.) :';
            temperatureLabel.textContent = 'Temp√©rature mesur√©e (¬∞C) :';
        }
    }

    function calculateVCF(densiteRelative15, temperature, type) {
        // Convertit la densit√© relative (ex: 0.850) en densit√© en kg/m¬≥ (ex: 850)
        // car les formules ASTM l'exigent.
        const density_kgm3 = densiteRelative15 * 1000;

        const T_degre = temperature - INITIAL_TEMP; // Ceci est ŒîT
        let vcf;

        if (type === 'brut') {
            // Table 54A: P√©trole Brut
            const K0 = 613.9723;
            const K1 = 0;
            const K2 = 0;
            const alpha60 = (K0 + K1 * density_kgm3 + K2 * density_kgm3 * density_kgm3) / (density_kgm3 * density_kgm3);
            vcf = Math.exp(-alpha60 * T_degre * (1 + 0.8 * alpha60 * T_degre));
        } else {
            // Table 54B: Produits Raffin√©s
            let K0, K1, K2;
            if (density_kgm3 <= 770) {
                 K0 = 346.42278;
                 K1 = 0.43884;
                 K2 = 0;
            } else if (density_kgm3 > 770 && density_kgm3 < 778) {
                // Cas sp√©cial pour cette plage √©troite
                const A = -0.00033612;
                const B = 2680.32;
                const alpha = A + B / (density_kgm3 * density_kgm3);
                vcf = Math.exp(-alpha * T_degre * (1 + 0.8 * alpha * T_degre));
                return vcf; // Retourne directement pour ce cas
            } else if (density_kgm3 >= 778 && density_kgm3 < 839) {
                K0 = 594.5418;
                K1 = 0;
                K2 = 0;
            } else { // density_kgm3 >= 839
                K0 = 186.9696;
                K1 = 0.48618;
                K2 = 0;
            }
            const alpha60 = (K0 + K1 * density_kgm3 + K2 * density_kgm3 * density_kgm3) / (density_kgm3 * density_kgm3);
            vcf = Math.exp(-alpha60 * T_degre * (1 + 0.8 * alpha60 * T_degre));
        }

        return vcf;
    }

    function calculateVolume() {
        const initialVolume = parseFloat(document.getElementById('initialVolume').value);
        const temperature = parseFloat(document.getElementById('temperature').value);
        const density15 = parseFloat(document.getElementById('density15').value);
        const productType = document.getElementById('productType').value;
        const direction = document.getElementById('conversionDirection').value;

        if (isNaN(initialVolume) || isNaN(temperature) || isNaN(density15) || initialVolume <= 0 || density15 <= 0) {
            alert("Veuillez entrer des valeurs num√©riques valides et positives.");
            return;
        }

        const vcf = calculateVCF(density15, temperature, productType);

        let finalVolume;
        let resultText = '';

        if (direction === 'toOther') {
            // De 15¬∞C vers T, on divise par le VCF
            finalVolume = initialVolume / vcf;
            resultText = `Le volume √† ${temperature.toFixed(2)} ¬∞C est de <b>${finalVolume.toFixed(2)}</b>.`;
        } else {
            // De T vers 15¬∞C, on multiplie par le VCF
            finalVolume = initialVolume * vcf;
            resultText = `Le volume corrig√© √† 15 ¬∞C est de <b>${finalVolume.toFixed(2)}</b>.`;
        }

        const resultDiv = document.getElementById('resultConverter');
        resultDiv.innerHTML = resultText + `<br><small style="color:var(--text-muted); font-size:0.8em; margin-top:5px; display:block;">(Facteur de correction (VCF) calcul√©: ${vcf.toFixed(6)})</small>`;
        resultDiv.style.display = 'block';
    }

    // Init
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        applyTheme(savedTheme);
    }
    addShoreTank();
    addLoadingProduct();
    updateLabels();
</script>

    <script src="cordova.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; media-src *; img-src 'self' data: content:;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Calculateur Maritime</title>
    <style>
        :root {
            /* iOS Colors */
            --ios-blue: #007AFF;
            --ios-orange: #FF9500;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-gray: #8E8E93;
            --ios-gray2: #AEAEB2;
            --ios-bg: #F2F2F7;
            --ios-card-bg: #FFFFFF;
            --ios-separator: #C6C6C8;
            --ios-text: #000000;
            --ios-text-secondary: #8A8A8E;
            --nav-bg: rgba(249, 249, 249, 0.8);

            /* App Specific */
            --bg-gradient-start: #0f2027;
            --bg-gradient-mid: #203a43;
            --bg-gradient-end: #2c5364;
        }

        [data-theme="dark"] {
            --ios-blue: #0A84FF;
            --ios-orange: #FF9F0A;
            --ios-red: #FF453A;
            --ios-green: #30D158;
            --ios-gray: #8E8E93;
            --ios-gray2: #636366;
            --ios-bg: #000000;
            --ios-card-bg: #1C1C1E;
            --ios-separator: #38383A;
            --ios-text: #FFFFFF;
            --ios-text-secondary: #8E8E93;
            --nav-bg: rgba(29, 29, 29, 0.8);

            --bg-gradient-start: #000000;
            --bg-gradient-mid: #1c1c1e;
            --bg-gradient-end: #2c2c2e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-mid), var(--bg-gradient-end));
            background-attachment: fixed; /* Ensures gradient covers scroll */
            color: var(--ios-text);
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            overflow-y: auto;
        }

        /* Fixed Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            padding-top: env(safe-area-inset-top);
            background: var(--nav-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--ios-separator);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--ios-text);
        }

        header h1 {
            font-size: 17px;
            font-weight: 600;
            margin: 0;
        }

        .theme-toggle-icon {
            position: absolute;
            right: 15px;
            top: calc(15px + env(safe-area-inset-top)); /* Adjust for status bar */
            cursor: pointer;
            font-size: 1.2rem;
            background: none;
            border: none;
            color: var(--ios-blue);
        }

        /* Main Content */
        .container {
            padding-top: calc(60px + env(safe-area-inset-top));
            padding-bottom: 90px; /* Space for bottom nav */
            padding-left: 15px;
            padding-right: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Grouped List / Card Style */
        .ios-section {
            margin-bottom: 25px;
        }

        .section-title {
            text-transform: uppercase;
            color: var(--ios-text-secondary);
            font-size: 13px;
            margin-bottom: 8px;
            margin-left: 15px;
            font-weight: 400;
        }

        .ios-card {
            background: var(--ios-card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .ios-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 0.5px solid var(--ios-separator);
            background: var(--ios-card-bg);
            font-size: 17px;
        }

        .ios-list-item:last-child {
            border-bottom: none;
        }

        .ios-list-item label {
            flex: 1;
            margin: 0;
            font-weight: 400;
        }

        .ios-list-item input,
        .ios-list-item select {
            flex: 1;
            text-align: right;
            border: none;
            background: transparent;
            font-size: 17px;
            color: var(--ios-blue);
            font-family: inherit;
            outline: none;
            width: 100%;
            min-width: 0; /* Fix flex issue */
        }

        .ios-list-item input::placeholder {
            color: var(--ios-gray2);
        }

        /* Stacked inputs for mobile specific fields if needed */
        .ios-list-item.stacked {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        .ios-list-item.stacked input {
            text-align: left;
            padding-left: 0;
        }

        /* Buttons */
        .btn-ios {
            background-color: var(--ios-blue);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 14px;
            width: 100%;
            font-size: 17px;
            font-weight: 600;
            margin-top: 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .btn-ios:active {
            opacity: 0.8;
        }

        .btn-ios-secondary {
            background-color: var(--ios-card-bg);
            color: var(--ios-blue);
            border: 1px solid var(--ios-blue);
            margin-top: 5px;
        }

        .btn-ios-orange {
            background-color: var(--ios-orange);
            color: white;
        }

        .btn-delete {
            background: var(--ios-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
        }

        /* Results */
        .result-box {
            background: var(--ios-card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid var(--ios-green);
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 16px;
        }
        .result-divider {
            height: 1px;
            background: var(--ios-separator);
            margin: 10px 0;
            border: none;
        }

        /* Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--nav-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid var(--ios-separator);
            display: flex;
            justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom);
            height: 55px;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--ios-gray);
            font-size: 10px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px 0;
        }

        .nav-item.active {
            color: var(--ios-blue);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 3px;
            fill: currentColor;
        }

        /* Tabs Logic */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeEffect 0.3s; }
        @keyframes fadeEffect { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }

        /* Specific Helper Classes */
        .text-orange { color: var(--ios-orange); }
        .text-muted { color: var(--ios-text-secondary); }
        .text-danger { color: var(--ios-red); }

        /* Checkbox styling override */
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--ios-blue);
        }

    </style>
</head>
<body>

<header>
    <h1>Calculateur Langlois</h1>
    <button class="theme-toggle-icon" onclick="toggleTheme()" id="themeBtn">üåô</button>
</header>

<div class="container">

    <!-- Configuration Tab -->
    <div id="config" class="tab-content active">
        <div class="ios-section">
            <div class="section-title">Param√®tres du Navire</div>
            <div class="ios-card">
                <div class="ios-list-item">
                    <label>DWT (Tonnes)</label>
                    <input type="number" id="shipDwt" placeholder="Ex: 50000">
                </div>
                <div class="ios-list-item">
                    <label>Produit</label>
                    <select id="productSelect" onchange="updateDensityFromSelect()">
                        <option value="custom">Choisir...</option>
                        <option value="0.740">Essence (0.740)</option>
                        <option value="0.850">Diesel (0.850)</option>
                        <option value="0.980">HFO (0.980)</option>
                    </select>
                </div>
                <div class="ios-list-item">
                    <label>Densit√© (SG)</label>
                    <input type="number" id="density" value="1.025" step="0.001">
                </div>
                <div class="ios-list-item">
                    <label>Nb. Tanks</label>
                    <input type="number" id="numTanks" placeholder="Ex: 10">
                </div>
            </div>
        </div>

        <div class="ios-section">
             <div class="section-title">Dimensions (Est. Hauteur)</div>
             <div class="ios-card">
                 <div class="ios-list-item">
                     <label>Longueur (m)</label>
                     <input type="number" id="shipLength" placeholder="LOA">
                 </div>
                 <div class="ios-list-item">
                     <label>Largeur (m)</label>
                     <input type="number" id="shipBeam" placeholder="Beam">
                 </div>
                 <div class="ios-list-item" style="padding: 0;">
                     <button class="btn-ios btn-ios-secondary" style="margin:0; border-radius:0; border:none; width:100%;" onclick="estimateHeightFromDwt()">Estimer Hauteur</button>
                 </div>
             </div>
        </div>

        <div class="ios-section">
            <div class="section-title">Hauteur Totale</div>
            <div class="ios-card">
                <div class="ios-list-item">
                    <label>Hauteur (m)</label>
                    <input type="number" id="tankHeight" placeholder="Calcul√© ou manuel">
                </div>
            </div>
        </div>

        <button class="btn-ios" onclick="saveConfig()">Sauvegarder</button>
        <div id="configMsg" class="result-box" style="background: var(--ios-green); color: white; border:none; text-align: center;">
            Sauvegard√© !
        </div>
    </div>

    <!-- Calc 1m Tab -->
    <div id="calc1m" class="tab-content">
        <div class="ios-section">
            <div class="section-title">Calcul rapide</div>
             <div class="ios-card" style="padding:15px; text-align:center; background: transparent; box-shadow:none;">
                <p style="color: var(--ios-text-secondary);">Utilise la configuration actuelle pour calculer le volume requis pour 1 m√®tre de niveau.</p>
             </div>
            <button class="btn-ios" onclick="calculateOneMeter()">Calculer Volume / 1m</button>
        </div>

        <div id="result1m" class="result-box">
            <div class="result-row"><strong>Vol. Total :</strong> <span><span id="totalVol">0</span> m¬≥</span></div>
            <div class="result-row"><strong>Hauteur :</strong> <span><span id="usedHeight">0</span> m</span></div>
            <hr class="result-divider">
            <div class="result-row" style="color: var(--ios-blue); font-weight: bold;">
                1m (1 tank) : <span id="volOneTank1m">0</span> m¬≥
            </div>
            <div class="result-row">
                1m (Total) : <span id="volAllTanks1m">0</span> m¬≥
            </div>
        </div>
    </div>

    <!-- Converter Tab -->
    <div id="converter" class="tab-content">
        <div class="ios-section">
            <div class="section-title">Conversion 54A / 54B</div>
            <div class="ios-card">
                <div class="ios-list-item stacked">
                    <label>Sens</label>
                    <select id="conversionDirection" onchange="updateLabels()">
                        <option value="toOther">15¬∞C ‚ûú Autre Temp</option>
                        <option value="to15">Autre Temp ‚ûú 15¬∞C</option>
                    </select>
                </div>
                <div class="ios-list-item">
                    <label id="initialVolumeLabel">Vol. @ 15¬∞C</label>
                    <input type="number" id="initialVolume" step="any">
                </div>
                <div class="ios-list-item">
                    <label id="temperatureLabel">Temp (¬∞C)</label>
                    <input type="number" id="temperature" step="any">
                </div>
                <div class="ios-list-item">
                    <label>Densit√© @ 15¬∞C</label>
                    <input type="number" id="density15" placeholder="Ex: 0.850" step="0.0001">
                </div>
                 <div class="ios-list-item">
                    <label>Type</label>
                    <select id="productType">
                        <option value="brut">Brut (54A)</option>
                        <option value="raffiner">Raffin√© (54B)</option>
                    </select>
                </div>
            </div>
        </div>

        <button class="btn-ios" onclick="calculateVolume()">Convertir</button>
        <div id="resultConverter" class="result-box"></div>
    </div>

    <!-- Loading Tab -->
    <div id="loading" class="tab-content">
         <div class="ios-section">
            <div class="section-title">Param√®tres G√©n√©raux</div>
            <div class="ios-card">
                <div class="ios-list-item">
                    <label>D√©but</label>
                    <input type="datetime-local" id="loadStartTime">
                </div>
            </div>
        </div>

        <div class="ios-section">
            <div class="section-title">S√©quence Produits</div>
            <div id="loadingProductsContainer"></div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-ios btn-ios-secondary" onclick="addLoadingProduct()" style="flex:2;">+ Ajouter Produit</button>
                <button class="btn-ios btn-ios-secondary" onclick="resetLoadingProducts()" style="flex:1; border-color:var(--ios-red); color:var(--ios-red);">Reset</button>
            </div>
        </div>

        <button class="btn-ios btn-ios-orange" onclick="calculateLoading()">Calculer Chargement</button>

        <div id="resultLoad" class="result-box">
            <div class="result-row"><strong>Reste :</strong> <span><span id="loadRemaining">0</span> m¬≥</span></div>
            <div class="result-row"><strong>Progression :</strong> <span id="loadPercent">0</span> %</div>
            <hr class="result-divider">
            <div class="result-row" style="font-size: 1.3em; font-weight: bold;">
                Temps : <span id="loadTime">0h 00m</span>
            </div>
            <div id="loadExtraInfo" style="margin-top:15px; border-top: 1px dashed var(--ios-separator); padding-top:10px;"></div>
        </div>
    </div>

    <!-- Unloading Tab -->
    <div id="unloading" class="tab-content">
        <div class="ios-section">
            <div class="section-title">Donn√©es G√©n√©rales</div>
            <div class="ios-card">
                 <div class="ios-list-item">
                    <label>D√©but</label>
                    <input type="datetime-local" id="unloadStartTime">
                </div>
                <div class="ios-list-item">
                    <label>Vol. Initial</label>
                    <input type="number" id="unloadStart">
                </div>
                <div class="ios-list-item">
                    <label>D√©j√† Pomp√©</label>
                    <input type="number" id="unloadDischarged">
                </div>
                <div class="ios-list-item">
                    <label>Taux (m¬≥/h)</label>
                    <input type="number" id="unloadRate">
                </div>
            </div>
        </div>

        <div class="ios-section">
            <div class="section-title">R√©servoirs √† Terre (Shore Tanks)</div>
            <div id="shoreTanksContainer"></div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-ios btn-ios-secondary" onclick="addShoreTank()" style="flex:2;">+ Ajouter R√©servoir</button>
                <button class="btn-ios btn-ios-secondary" onclick="resetShoreTanks()" style="flex:1; border-color:var(--ios-red); color:var(--ios-red);">Reset</button>
            </div>
        </div>

        <button class="btn-ios btn-ios-orange" onclick="calculateUnloading()">Calculer D√©chargement</button>

        <div id="resultUnload" class="result-box">
            <div class="result-row"><strong>D√©charg√© :</strong> <span><span id="unloadDone">0</span> m¬≥</span></div>
            <div class="result-row"><strong>Reste :</strong> <span><span id="unloadRemaining">0</span> m¬≥</span></div>
            <hr class="result-divider">
            <div class="result-row" style="font-size: 1.3em; font-weight: bold;">
                Temps : <span id="unloadTime">0h 00m</span>
            </div>
            <div id="unloadExtraInfo" style="margin-top:15px; border-top: 1px dashed var(--ios-separator); padding-top:10px;"></div>
        </div>
    </div>

</div> <!-- End Container -->

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <button class="nav-item active" onclick="openTab('config', this)">
        <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
        Config
    </button>
    <button class="nav-item" onclick="openTab('calc1m', this)">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
        Calcul 1m
    </button>
    <button class="nav-item" onclick="openTab('converter', this)">
        <svg viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
        Convert
    </button>
    <button class="nav-item" onclick="openTab('loading', this)">
        <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
        Chargement
    </button>
    <button class="nav-item" onclick="openTab('unloading', this)">
        <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        D√©charg.
    </button>
</nav>

<script>
    // --- Theme Logic ---
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
        localStorage.setItem('theme', newTheme);
    }

    function applyTheme(theme) {
        const html = document.documentElement;
        const btn = document.getElementById('themeBtn');
        if (theme === 'dark') {
            html.setAttribute('data-theme', 'dark');
            btn.innerText = '‚òÄÔ∏è';
        } else {
            html.removeAttribute('data-theme');
            btn.innerText = 'üåô';
        }
    }

    // --- Tab Logic ---
    function openTab(tabName, el) {
        // Hide all tabs
        const contents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < contents.length; i++) {
            contents[i].style.display = "none";
            contents[i].classList.remove("active");
        }

        // Deactivate all nav items
        const items = document.getElementsByClassName("nav-item");
        for (let i = 0; i < items.length; i++) {
            items[i].classList.remove("active");
        }

        // Activate selected
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");

        // If el is passed (clicked), activate it. If not (default), find it.
        if (el) {
            el.classList.add("active");
        }
    }

    // Variables
    let dwt = 0;
    let tanks = 0;
    let height = 0;
    let density = 1.025;

    function updateDensityFromSelect() {
        const sel = document.getElementById("productSelect").value;
        if (sel !== "custom") document.getElementById("density").value = sel;
    }

    // --- NOUVELLE FONCTION : Estimation de la hauteur ---
    function estimateHeightFromDwt() {
        let d = parseFloat(document.getElementById('shipDwt').value) || 0;
        let den = parseFloat(document.getElementById('density').value) || 1.025;
        let l = parseFloat(document.getElementById('shipLength').value) || 0;
        let w = parseFloat(document.getElementById('shipBeam').value) || 0;

        if (d === 0 || l === 0 || w === 0) {
            alert("Veuillez remplir DWT, Longueur et Largeur.");
            return;
        }

        let totalVolume = d / den;
        let area = l * w;
        let estimatedHeight = totalVolume / (area * 0.85);

        document.getElementById('tankHeight').value = estimatedHeight.toFixed(2);
    }

    function saveConfig() {
        dwt = parseFloat(document.getElementById('shipDwt').value) || 0;
        tanks = parseFloat(document.getElementById('numTanks').value) || 0;
        height = parseFloat(document.getElementById('tankHeight').value) || 0;
        density = parseFloat(document.getElementById('density').value) || 1.025;

        const msg = document.getElementById('configMsg');
        msg.style.display = 'block';
        setTimeout(() => { msg.style.display = 'none'; }, 2000);
    }

    function calculateOneMeter() {
        saveConfig();
        if (dwt === 0 || tanks === 0 || height === 0) {
            alert("Config incompl√®te (DWT, Tanks ou Hauteur).");
            return;
        }

        let totalVolumeCapacity = dwt / density;
        let volumePerTank = totalVolumeCapacity / tanks;
        let volumePerMeter = volumePerTank / height;

        document.getElementById('totalVol').innerText = totalVolumeCapacity.toFixed(1);
        document.getElementById('usedHeight').innerText = height.toFixed(2);
        document.getElementById('volOneTank1m').innerText = volumePerMeter.toFixed(2);
        document.getElementById('volAllTanks1m').innerText = (volumePerMeter * tanks).toFixed(2);

        document.getElementById('result1m').style.display = 'block';
    }

    // --- Loading Multiple Products Logic ---
    let loadProdCount = 0;
    function addLoadingProduct() {
        loadProdCount++;
        const div = document.createElement('div');
        div.className = 'ios-card';
        div.style.marginBottom = '15px';

        div.innerHTML = `
            <div class="ios-list-item" style="background:var(--ios-bg); border-bottom:1px solid var(--ios-separator);">
                <input type="text" placeholder="Nom Produit (Ex: Essence)" class="load-prod-name" style="text-align:left; font-weight:600; color:var(--ios-text);">
                <button onclick="this.parentElement.parentElement.remove()" class="btn-delete">‚úï</button>
            </div>

            <div class="ios-list-item">
                <label>Total (m¬≥)</label>
                <input type="number" class="load-prod-target">
            </div>
            <div class="ios-list-item">
                <label>√Ä bord (m¬≥)</label>
                <input type="number" class="load-prod-current">
            </div>
            <div class="ios-list-item">
                <label>Taux (m¬≥/h)</label>
                <input type="number" class="load-prod-rate">
            </div>

            <div class="ios-list-item">
                 <label>Echantillonnage (45m)</label>
                 <input type="checkbox" class="load-prod-sampling">
            </div>

            <div class="ios-list-item">
                 <label>Arr√™t D√©placement</label>
                 <input type="checkbox" class="load-prod-shift-toggle" onchange="this.parentElement.nextElementSibling.style.display = this.checked ? 'block' : 'none'">
            </div>

            <div class="load-prod-shift-details" style="display:none; background: var(--ios-bg);">
                 <div class="ios-list-item">
                    <label style="font-size:0.9em">Arr√™t si reste (m¬≥)</label>
                    <input type="number" class="load-prod-shift-rem">
                 </div>
                 <div class="ios-list-item">
                    <label style="font-size:0.9em">Dur√©e Arr√™t (min)</label>
                    <input type="number" class="load-prod-shift-dur">
                 </div>
            </div>

            <div class="ios-list-item">
                <label>D√©lai Apr√®s (min)</label>
                <input type="number" class="load-prod-delay-after">
            </div>
        `;
        document.getElementById('loadingProductsContainer').appendChild(div);
    }

    function resetLoadingProducts() {
        document.getElementById('loadingProductsContainer').innerHTML = '';
        loadProdCount = 0;
        addLoadingProduct();
    }

    function calculateLoading() {
        let totalTarget = 0;
        let totalCurrent = 0;
        let totalRemaining = 0;
        let totalTimeHours = 0;

        let startTimeVal = document.getElementById('loadStartTime').value;
        let now = startTimeVal ? new Date(startTimeVal) : new Date();

        let cumulativeTimeMins = 0;
        let extraHtml = "";
        let productScheduleHtml = "";

        const rows = document.querySelectorAll('#loadingProductsContainer > .ios-card');
        let hasData = false;

        if (rows.length > 0) {
             productScheduleHtml += `<div style="margin-top:15px; padding-top:10px;"><h4 class="section-title" style="margin-left:0;">S√©quence</h4>`;
        }

        rows.forEach(row => {
            let name = row.querySelector('.load-prod-name').value || "Produit";
            let t = parseFloat(row.querySelector('.load-prod-target').value) || 0;
            let c = parseFloat(row.querySelector('.load-prod-current').value) || 0;
            let r = parseFloat(row.querySelector('.load-prod-rate').value) || 0;
            let delayAfter = parseFloat(row.querySelector('.load-prod-delay-after').value) || 0;

            let rem = t - c;
            if (rem < 0) rem = 0;

            totalTarget += t;
            totalCurrent += c;
            totalRemaining += rem;

            if (t > 0 || r > 0) hasData = true;

            let samplingEnabled = row.querySelector('.load-prod-sampling').checked;
            if (samplingEnabled) cumulativeTimeMins += 45;

            let shiftEnabled = row.querySelector('.load-prod-shift-toggle').checked;
            let shiftDuration = 0;
            let shiftMsg = "";
            let pumpingDurationHours = (r > 0) ? (rem / r) : 0;
            let pumpingDurationMins = pumpingDurationHours * 60;

            if (shiftEnabled && rem > 0 && r > 0) {
                 let shiftTrigger = parseFloat(row.querySelector('.load-prod-shift-rem').value) || 0;
                 let shiftDurInput = parseFloat(row.querySelector('.load-prod-shift-dur').value) || 0;
                 let volBeforeStop = rem - shiftTrigger;

                 if (volBeforeStop > 0) {
                     let timeToStopMins = (volBeforeStop / r) * 60;
                     shiftDuration = shiftDurInput;
                     cumulativeTimeMins += timeToStopMins;
                     let stopDate = addMinutes(now, cumulativeTimeMins);
                     cumulativeTimeMins += shiftDuration;
                     let remainingPumpingMins = pumpingDurationMins - timeToStopMins;
                     cumulativeTimeMins += remainingPumpingMins;
                     shiftMsg = `<div class="text-orange" style="font-size:0.9em; margin-left:10px;">‚ûú Arr√™t d√©pla. (${shiftDuration}m) √† ${formatDateTime(stopDate)}</div>`;
                 } else {
                     cumulativeTimeMins += pumpingDurationMins;
                 }
            } else {
                 cumulativeTimeMins += pumpingDurationMins;
            }

            if (delayAfter > 0) cumulativeTimeMins += delayAfter;

            totalTimeHours = cumulativeTimeMins / 60;
            let pEndDate = addMinutes(now, cumulativeTimeMins);

            if (rem > 0 || delayAfter > 0 || samplingEnabled) {
                productScheduleHtml += `
                    <div style="margin-bottom:8px; border-bottom:1px solid var(--ios-separator); padding-bottom:5px;">
                        <div style="display:flex; justify-content:space-between; font-size:1em;">
                            <strong>${name} (${rem.toFixed(0)} m¬≥)</strong>
                            <span>${formatDateTime(pEndDate)}</span>
                        </div>
                        ${samplingEnabled ? `<div class="text-orange" style="font-size:0.9em; margin-left:10px;">‚ûú Echantillonnage 1m (+45 min)</div>` : ''}
                        ${shiftMsg}
                        ${delayAfter > 0 ? `<div class="text-muted" style="font-size:0.9em; margin-left:10px;">‚ûú D√©lai apr√®s : ${delayAfter} min</div>` : ''}
                    </div>
                `;
            }
        });

        productScheduleHtml += `</div>`;

        if (!hasData) return;

        let percent = (totalTarget > 0) ? (totalCurrent / totalTarget) * 100 : 0;
        let h = Math.floor(totalTimeHours);
        let m = Math.round((totalTimeHours - h) * 60);
        let endDate = addMinutes(now, totalTimeHours * 60);

        document.getElementById('loadRemaining').innerText = totalRemaining.toFixed(1);
        document.getElementById('loadPercent').innerText = percent.toFixed(1);
        document.getElementById('loadTime').innerText = h + "h " + m + "m";
        document.getElementById('resultLoad').style.display = 'block';

        extraHtml = `<div class="result-row" style="margin-top:10px; font-weight:bold; color:var(--ios-blue);">Fin estim√©e : ${formatDateTime(endDate)}</div>`;
        extraHtml += productScheduleHtml;

        document.getElementById('loadExtraInfo').innerHTML = extraHtml;
    }

    // --- Unloading Logic ---
    let tankCount = 0;
    function addShoreTank() {
        tankCount++;
        const div = document.createElement('div');
        div.className = 'ios-card';
        div.style.marginBottom = '15px';

        div.innerHTML = `
            <div class="ios-list-item" style="background:var(--ios-bg); border-bottom:1px solid var(--ios-separator);">
                <input type="text" placeholder="Nom (Ex: Tk 1)" class="tank-name" style="text-align:left; font-weight:600; color:var(--ios-text);">
                <button onclick="this.parentElement.parentElement.remove()" class="btn-delete">‚úï</button>
            </div>
            <div class="ios-list-item">
                <label>Qt√© (m¬≥)</label>
                <input type="number" class="tank-qty">
            </div>
            <div class="ios-list-item">
                <label>D√©lai Avant (min)</label>
                <input type="number" class="tank-delay">
            </div>

            <div class="tank-bypass-start ios-list-item" style="display:none;"> <!-- CSS logic handles display -->
                 <label class="text-danger">Bypass 30m Start</label>
                 <input type="checkbox" class="tank-bypass-check">
            </div>

            <div class="ios-list-item">
                <label class="text-orange">Ralentissement</label>
                <input type="checkbox" class="tank-slow-toggle" onchange="this.parentElement.nextElementSibling.style.display = this.checked ? 'block' : 'none'">
            </div>

            <div class="tank-slow-inputs" style="display:none; background:var(--ios-bg);">
                 <div class="ios-list-item">
                    <label style="font-size:0.9em">D√©bit Restreint</label>
                    <input type="number" class="tank-slow-rate">
                 </div>
                 <div class="ios-list-item">
                    <label style="font-size:0.9em">Dur√©e (min)</label>
                    <input type="number" class="tank-slow-dur">
                 </div>
            </div>
        `;
        document.getElementById('shoreTanksContainer').appendChild(div);

        // Re-apply visibility logic for bypass
        updateBypassVisibility();
    }

    function updateBypassVisibility() {
        const rows = document.querySelectorAll('#shoreTanksContainer > .ios-card');
        rows.forEach((row, index) => {
            const bypassDiv = row.querySelector('.tank-bypass-start');
            if (bypassDiv) {
                bypassDiv.style.display = (index === 0) ? 'flex' : 'none';
            }
        });
    }

    // Observer to handle DOM changes for bypass logic since we can't use :first-child easily with wrapped divs?
    // Actually :first-child works on the wrapper. But let's be safe.
    // The previous CSS :first-child logic was: #shoreTanksContainer .shore-tank-row:first-child .tank-bypass-start
    // My new HTML structure is: #shoreTanksContainer > .ios-card > ... > .tank-bypass-start
    // So CSS: #shoreTanksContainer > .ios-card:first-child .tank-bypass-start { display: flex !important; } should work.

    function resetShoreTanks() {
        document.getElementById('shoreTanksContainer').innerHTML = '';
        tankCount = 0;
        addShoreTank();
    }

    function calculateUnloading() {
        let start = parseFloat(document.getElementById('unloadStart').value) || 0;
        let discharged = parseFloat(document.getElementById('unloadDischarged').value) || 0;
        let rate = parseFloat(document.getElementById('unloadRate').value) || 0;
        if (rate === 0) return;

        let current = start - discharged;
        if (current < 0) current = 0;

        let startTimeVal = document.getElementById('unloadStartTime').value;
        let now = startTimeVal ? new Date(startTimeVal) : new Date();
        let extraHtml = "";

        const tankRows = document.querySelectorAll('#shoreTanksContainer > .ios-card');
        let hasTanks = false;
        tankRows.forEach(row => { if(row.querySelector('.tank-qty').value) hasTanks = true; });

        let totalDurationMins = 0;

        if (hasTanks) {
            extraHtml += `<div style="margin-top:15px; padding-top:10px;"><h4 class="section-title" style="margin-left:0;">S√©quence</h4>`;
            let totalTankQty = 0;

            tankRows.forEach((row, index) => {
                let name = row.querySelector('.tank-name').value || `R√©servoir ${index + 1}`;
                let qty = parseFloat(row.querySelector('.tank-qty').value) || 0;
                let delay = parseFloat(row.querySelector('.tank-delay').value) || 0;
                let slowRateInput = parseFloat(row.querySelector('.tank-slow-rate').value) || 0;
                let slowDurInput = parseFloat(row.querySelector('.tank-slow-dur').value) || 0;
                let useSlowdown = row.querySelector('.tank-slow-toggle').checked && slowRateInput > 0 && slowDurInput > 0;

                if (qty > 0) {
                    totalTankQty += qty;
                    totalDurationMins += delay;
                    let tankDurationMins = 0;
                    let remainingQty = qty;
                    let msgs = [];

                    let bypassCheck = row.querySelector('.tank-bypass-check');
                    let isBypass = (index === 0 && bypassCheck && bypassCheck.checked);

                    if (!isBypass) {
                        let startDur = 30;
                        let startRate = (rate > 3000) ? 3000 : rate;
                        let startVol = startRate * (startDur / 60);

                        if (remainingQty <= startVol) {
                            let time = (remainingQty / startRate) * 60;
                            tankDurationMins += time;
                            msgs.push(`<div class="text-muted" style="font-size:0.85em; margin-left:10px;">‚ûú D√©marrage : ${time.toFixed(1)}m (Fin)</div>`);
                            remainingQty = 0;
                        } else {
                            tankDurationMins += startDur;
                            remainingQty -= startVol;
                            msgs.push(`<div class="text-muted" style="font-size:0.85em; margin-left:10px;">‚ûú D√©marrage : 30m @ ${startRate.toFixed(0)}</div>`);
                        }
                    } else {
                        msgs.push(`<div class="text-danger" style="font-size:0.85em; margin-left:10px;">‚ûú D√©marrage bypass√©</div>`);
                    }

                    if (remainingQty > 0 && useSlowdown) {
                        let volDuringSlow = slowRateInput * (slowDurInput / 60);
                        if (remainingQty <= volDuringSlow) {
                            let time = (remainingQty / slowRateInput) * 60;
                            tankDurationMins += time;
                            msgs.push(`<div class="text-orange" style="font-size:0.85em; margin-left:10px;">‚ûú Ralenti : ${time.toFixed(1)}m (Fin)</div>`);
                            remainingQty = 0;
                        } else {
                            tankDurationMins += slowDurInput;
                            remainingQty -= volDuringSlow;
                            msgs.push(`<div class="text-orange" style="font-size:0.85em; margin-left:10px;">‚ûú Ralenti : ${slowDurInput}m @ ${slowRateInput}</div>`);
                        }
                    }

                    if (remainingQty > 0) {
                        let timeNormal = (remainingQty / rate) * 60;
                        tankDurationMins += timeNormal;
                    }

                    totalDurationMins += tankDurationMins;
                    let tankEndTime = addMinutes(now, totalDurationMins);

                    extraHtml += `
                        <div style="margin-bottom:8px; border-bottom:1px solid var(--ios-separator); padding-bottom:5px;">
                            <div style="display:flex; justify-content:space-between; font-size:1em;">
                                <span>${name} (${qty} m¬≥)</span>
                                <span style="font-weight:600;">${formatDateTime(tankEndTime)}</span>
                            </div>
                            ${delay > 0 ? `<div class="text-muted" style="font-size:0.85em; margin-left:10px;">‚ûú D√©lai : ${delay} min</div>` : ''}
                            ${msgs.join('')}
                        </div>
                    `;
                }
            });

            let unassigned = current - totalTankQty;
            if (unassigned > 0.01) {
                 let unassignedHours = unassigned / rate;
                 let unassignedMins = unassignedHours * 60;
                 totalDurationMins += unassignedMins;
                 let finalEndTime = addMinutes(now, totalDurationMins);
                 extraHtml += `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.95em; color:var(--ios-text-secondary); font-style:italic;">
                        <span>Non assign√© (${unassigned.toFixed(1)} m¬≥)</span>
                        <span>${formatDateTime(finalEndTime)}</span>
                    </div>
                `;
            } else if (unassigned < -0.01) {
                 extraHtml += `<div class="text-danger" style="font-size:0.9em;">Attention: Somme r√©servoirs (${totalTankQty} m¬≥) > Reste !</div>`;
            }

            let finalDate = addMinutes(now, totalDurationMins);
            extraHtml = `<div class="result-row" style="margin-top:10px; font-weight:bold; color:var(--ios-blue);">Fin estim√©e : ${formatDateTime(finalDate)}</div>` + extraHtml;
            extraHtml += `</div>`;
        } else {
             let timeHours = current / rate;
             totalDurationMins = timeHours * 60;
             let endDate = addMinutes(now, totalDurationMins);
             extraHtml = `<div class="result-row" style="margin-top:10px; font-weight:bold; color:var(--ios-blue);">Fin estim√©e : ${formatDateTime(endDate)}</div>`;
        }

        let h = Math.floor(totalDurationMins / 60);
        let m = Math.round(totalDurationMins % 60);

        document.getElementById('unloadDone').innerText = discharged.toFixed(1);
        document.getElementById('unloadRemaining').innerText = current.toFixed(1);
        document.getElementById('unloadTime').innerText = h + "h " + m + "m";
        document.getElementById('resultUnload').style.display = 'block';

        document.getElementById('unloadExtraInfo').innerHTML = extraHtml;
    }

    // --- Utilitaires de Date ---
    function formatDateTime(date) {
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        return `${day}/${month} ${hours}:${minutes}`;
    }

    function addMinutes(date, minutes) {
        return new Date(date.getTime() + minutes * 60000);
    }

    // --- Converter ---
    function updateLabels() {
        const direction = document.getElementById('conversionDirection').value;
        const initialVolumeLabel = document.getElementById('initialVolumeLabel');
        const temperatureLabel = document.getElementById('temperatureLabel');

        if (direction === 'toOther') {
            initialVolumeLabel.textContent = 'Vol. @ 15¬∞C';
            temperatureLabel.textContent = 'Temp Cible (¬∞C)';
        } else {
            initialVolumeLabel.textContent = 'Vol. Mesur√©';
            temperatureLabel.textContent = 'Temp Mesur√©e (¬∞C)';
        }
    }

    function calculateVCF(densiteRelative15, temperature, type) {
        const density_kgm3 = densiteRelative15 * 1000;
        const INITIAL_TEMP = 15;
        const T_degre = temperature - INITIAL_TEMP;
        let vcf;

        if (type === 'brut') {
            const K0 = 613.9723;
            const K1 = 0;
            const K2 = 0;
            const alpha60 = (K0 + K1 * density_kgm3 + K2 * density_kgm3 * density_kgm3) / (density_kgm3 * density_kgm3);
            vcf = Math.exp(-alpha60 * T_degre * (1 + 0.8 * alpha60 * T_degre));
        } else {
            let K0, K1, K2;
            if (density_kgm3 <= 770) {
                 K0 = 346.42278; K1 = 0.43884; K2 = 0;
            } else if (density_kgm3 > 770 && density_kgm3 < 778) {
                const A = -0.00033612;
                const B = 2680.32;
                const alpha = A + B / (density_kgm3 * density_kgm3);
                return Math.exp(-alpha * T_degre * (1 + 0.8 * alpha * T_degre));
            } else if (density_kgm3 >= 778 && density_kgm3 < 839) {
                K0 = 594.5418; K1 = 0; K2 = 0;
            } else {
                K0 = 186.9696; K1 = 0.48618; K2 = 0;
            }
            const alpha60 = (K0 + K1 * density_kgm3 + K2 * density_kgm3 * density_kgm3) / (density_kgm3 * density_kgm3);
            vcf = Math.exp(-alpha60 * T_degre * (1 + 0.8 * alpha60 * T_degre));
        }
        return vcf;
    }

    function calculateVolume() {
        const initialVolume = parseFloat(document.getElementById('initialVolume').value);
        const temperature = parseFloat(document.getElementById('temperature').value);
        const density15 = parseFloat(document.getElementById('density15').value);
        const productType = document.getElementById('productType').value;
        const direction = document.getElementById('conversionDirection').value;

        if (isNaN(initialVolume) || isNaN(temperature) || isNaN(density15)) {
            alert("Entr√©es invalides.");
            return;
        }

        const vcf = calculateVCF(density15, temperature, productType);
        let finalVolume, resultText;

        if (direction === 'toOther') {
            finalVolume = initialVolume / vcf;
            resultText = `Vol @ ${temperature.toFixed(1)}¬∞C: <b>${finalVolume.toFixed(2)}</b>`;
        } else {
            finalVolume = initialVolume * vcf;
            resultText = `Vol @ 15¬∞C: <b>${finalVolume.toFixed(2)}</b>`;
        }

        const resultDiv = document.getElementById('resultConverter');
        resultDiv.innerHTML = `<div class="result-row" style="font-size:1.1em; color:var(--ios-blue);">${resultText}</div><div class="result-row text-muted" style="font-size:0.8em;">VCF: ${vcf.toFixed(5)}</div>`;
        resultDiv.style.display = 'block';
    }

    // Init
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) applyTheme(savedTheme);

    // Add CSS for bypass visibility dynamically
    const style = document.createElement('style');
    style.innerHTML = `
        #shoreTanksContainer > .ios-card:first-child .tank-bypass-start { display: flex !important; }
    `;
    document.head.appendChild(style);

    addShoreTank();
    addLoadingProduct();
    updateLabels();

</script>
<script src="cordova.js"></script>
</body>
</html>